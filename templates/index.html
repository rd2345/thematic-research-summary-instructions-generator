<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Summary Creation Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Custom Summary Creation Tool</h1>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step {{ 'active' if step == 1 else 'completed' if step > 1 else '' }}">
                <span class="step-number">1</span>
                <span class="step-name">Select Example</span>
            </div>
            {% for i in range(2, 8) %}
                {% if i != 4 or dev_mode %}
                    <div class="step {{ 'active' if i == step else 'completed' if i < step else '' }}">
                        <span class="step-number">{{ i }}</span>
                        <span class="step-name">
                            {% if i == 2 %}Summary Description
                            {% elif i == 3 %}Review Instructions
                            {% elif i == 4 %}Review Prompt
                            {% elif i == 5 %}Run Inference
                            {% elif i == 6 %}Provide Feedback
                            {% elif i == 7 %}Final Results
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
            {% endfor %}
            {% if step == 7.5 %}
                <div class="step active">
                    <span class="step-number">7.5</span>
                    <span class="step-name">Prompt Analysis</span>
                </div>
            {% endif %}
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-messages">
                    {% for message in messages %}
                        <div class="alert alert-warning">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Step Content -->
        <div class="step-content">
            {% if step == 1 %}
                <!-- Step 1: Data Source Selection -->
                <div class="step-container">
                    <h2>Step 1: Select Conversation Dataset</h2>
                    <p>Choose a conversation dataset to work with for summarization:</p>
                    
                    <!-- Data Source Selection Tabs -->
                    <div class="data-source-tabs">
                        <button type="button" class="tab-button active" data-tab="examples">Pre-built Examples</button>
                        <button type="button" class="tab-button" data-tab="upload">Upload Your Own Data</button>
                    </div>
                    
                    <!-- Pre-built Examples Tab -->
                    <div class="tab-content active" id="examples-tab">
                        <form method="POST" action="{{ url_for('process_step') }}">
                            <input type="hidden" name="data_source" value="examples">
                            {% if examples %}
                                {% for filename, example in examples.items() %}
                                    <div class="example-option">
                                        <label>
                                            <input type="radio" name="selected_example" value="{{ filename }}">
                                            <div class="example-card">
                                                <h3>{{ example.name }}</h3>
                                                <p>{{ example.count }} conversations</p>
                                            </div>
                                        </label>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info">
                                    No conversation datasets found. Please add conversation_*.json files to the examples/ directory.
                                </div>
                            {% endif %}
                            
                            <button type="submit" class="btn btn-primary">Next Step</button>
                        </form>
                    </div>
                    
                    <!-- Custom Upload Tab -->
                    <div class="tab-content" id="upload-tab">
                        <div class="upload-section">
                            <h3>Upload Your Data File</h3>
                            <p>Supported formats: JSON (array of objects) or CSV files</p>
                            
                            <!-- File Upload Zone -->
                            <div class="upload-zone" id="upload-zone">
                                <div class="upload-content">
                                    <div class="upload-icon">üìÅ</div>
                                    <p><strong>Click to upload</strong> or drag and drop your file here</p>
                                    <p class="upload-hint">JSON or CSV files only (max 10MB)</p>
                                    <input type="file" id="file-input" accept=".json,.csv" style="display: none;">
                                </div>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div class="upload-progress" id="upload-progress" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar-inner" id="upload-progress-bar" style="width: 0%"></div>
                                </div>
                                <p id="upload-status">Uploading file...</p>
                            </div>
                            
                            <!-- CSV Column Selection (shown after CSV upload) -->
                            <div class="column-selection" id="column-selection" style="display: none;">
                                <h4>Select Comment Column</h4>
                                <p>Choose the column that contains the survey responses/comments:</p>
                                <div class="csv-preview" id="csv-preview"></div>
                                <div class="column-controls">
                                    <label for="column-select">Response Column:</label>
                                    <select id="column-select" class="form-control">
                                        <option value="">-- Select Column --</option>
                                    </select>
                                    <button type="button" id="process-csv" class="btn btn-primary" disabled>Process Selected Column</button>
                                </div>
                            </div>
                            
                            <!-- Upload Success -->
                            <div class="upload-success" id="upload-success" style="display: none;">
                                <div class="success-message">
                                    <div class="success-icon">‚úÖ</div>
                                    <h4 id="upload-filename">File uploaded successfully</h4>
                                    <p id="upload-summary">Found X valid responses</p>
                                </div>
                                <form method="POST" action="{{ url_for('process_step') }}">
                                    <input type="hidden" name="data_source" value="upload">
                                    <input type="hidden" name="uploaded_file" id="uploaded-file-input" value="">
                                    <button type="submit" class="btn btn-primary">Continue with Uploaded Data</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif step == 2 %}
                <!-- Step 2: Summarization Description -->
                <div class="step-container">
                    <h2>Step 2: Summary Description</h2>
                    
                    <p>Describe what aspects you want to summarize from the conversations. <em>Tip: 2-3 sentences work well for generating relevant summary categories.</em></p>
                    
                    <form method="POST" action="{{ url_for('process_step') }}">
                        <div class="form-group">
                            <label for="summary_description">Summarization Description:</label>
                            <textarea 
                                id="summary_description"
                                name="summary_description" 
                                rows="4" 
                                placeholder="Example: I want to create summaries focusing on customer satisfaction themes, sentiment patterns, and specific product or service feedback from these support conversations."
                                required>{{ session.get('summary_description', '') }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Generate Summary Information</button>
                    </form>
                    
                    <!-- Sample Responses Preview - moved to bottom -->
                    {% if dev_mode %}
                        {% if sample_responses %}
                            <div class="sample-responses-preview">
                                <p>Examples from the <strong>{{ selected_dataset_name }}</strong> dataset</p>
                                
                                <div class="sample-responses-box">
                                    <!-- Initial 3 examples -->
                                    {% for response in sample_responses[:3] %}
                                        <div class="sample-response-item">
                                            <div class="response-text">{{ response.text }}</div>
                                        </div>
                                    {% endfor %}
                                    
                                    <!-- Hidden additional examples (4-10) -->
                                    {% if sample_responses|length > 3 %}
                                        <div id="additional-examples" style="display: none;">
                                            {% for response in sample_responses[3:10] %}
                                                <div class="sample-response-item">
                                                    <div class="response-text">{{ response.text }}</div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- See more link -->
                                        <div class="see-more-container">
                                            <a href="#" id="see-more-examples" class="see-more-link">Show more examples</a>
                                            <a href="#" id="see-less-examples" class="see-less-link" style="display: none;">Show fewer examples</a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

            {% elif step == 3 %}
                <!-- Step 3: Summary Instructions Review -->
                <div class="step-container">
                    <h2>Step 3: Review Summary Instructions</h2>
                    
                    <form method="POST" action="{{ url_for('process_step') }}">
                        <!-- Data Source Analysis Results (Editable) -->
                        {% if data_source_analysis %}
                        <div class="data-analysis-section">
                            <h3>üìä Data Source Analysis <small style="font-weight: normal; color: #666;">(editable)</small></h3>
                            <div class="analysis-results">
                                
                                <!-- Data Source Type -->
                                <div class="analysis-item">
                                    <label for="data_source_type"><strong>Data Source Type:</strong></label>
                                    <input type="text" id="data_source_type" name="data_source_type" 
                                           value="{{ data_source_analysis.data_source_type }}" 
                                           class="form-control analysis-input"
                                           placeholder="e.g., Call Transcripts, Support Chats">
                                </div>
                                
                                <!-- Conversation Participants -->
                                <div class="analysis-item">
                                    <label><strong>Conversation Participants:</strong></label>
                                    <div id="participants-container">
                                        {% if data_source_analysis.author_types %}
                                            {% for author in data_source_analysis.author_types %}
                                                <div class="participant-row" data-index="{{ loop.index0 }}">
                                                    <div class="participant-fields">
                                                        <input type="text" 
                                                               name="participant_role_{{ loop.index0 }}" 
                                                               value="{{ author.role }}"
                                                               placeholder="Role (e.g., Agent, Customer)"
                                                               class="form-control participant-role">
                                                        <input type="text" 
                                                               name="participant_desc_{{ loop.index0 }}" 
                                                               value="{{ author.description }}"
                                                               placeholder="Role description"
                                                               class="form-control participant-desc">
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-participant">Remove</button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="participant-row" data-index="0">
                                                <div class="participant-fields">
                                                    <input type="text" 
                                                           name="participant_role_0" 
                                                           value=""
                                                           placeholder="Role (e.g., Agent, Customer)"
                                                           class="form-control participant-role">
                                                    <input type="text" 
                                                           name="participant_desc_0" 
                                                           value=""
                                                           placeholder="Role description"
                                                           class="form-control participant-desc">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-participant">Remove</button>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <button type="button" id="add-participant" class="btn btn-sm btn-outline-primary mt-2">
                                        + Add Participant
                                    </button>
                                </div>
                                
                                <!-- Business Context -->
                                <div class="analysis-item">
                                    <label for="business_context"><strong>Business Context:</strong></label>
                                    <textarea id="business_context" name="business_context" 
                                              class="form-control analysis-textarea" rows="3"
                                              placeholder="Describe the business domain and context">{{ data_source_analysis.business_context }}</textarea>
                                </div>
                                
                            </div>
                        </div>
                        {% endif %}
                        
                        <p>We've generated detailed instructions for summarizing conversations based on your criteria. Review and customize them as needed:</p>
                        <div class="form-group">
                            <label for="summary_instructions">Summary Instructions:</label>
                            <textarea 
                                id="summary_instructions" 
                                name="summary_instructions" 
                                rows="15" 
                                placeholder="Detailed instructions for how to summarize the conversations..."
                                required>{{ summary_instructions }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Generate Instructions</button>
                    </form>
                </div>

            {% elif step == 4 and dev_mode %}
                <!-- Step 4: Prompt Review (Dev Mode Only) -->
                <div class="step-container">
                    <h2>Step 4: Review and Edit Instructions</h2>
                    <p>We've generated summarization instructions based on your criteria and summary types. Review and customize as needed:</p>
                    
                    <div class="alert alert-info">
                        <strong>Generated Instructions:</strong> This will not be shown to the customer. But is shown here for development / prototyping purposes.
                    </div>
                    
                    <form method="POST" action="{{ url_for('process_step') }}">
                        <div class="form-group">
                            <label for="prompt">Summarization Instructions:</label>
                            <textarea id="prompt" name="prompt" rows="15" required>{{ prompt }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Run Inference</button>
                    </form>
                </div>

            {% elif step == 5 %}
                <!-- Step 5: Run Inference -->
                <div class="step-container">
                    <h2>Step 5: Generating Conversation Summaries</h2>
                    <p>Creating detailed summaries for each conversation...</p>
                    
                    <div class="alert alert-info">
                        <strong>Individual Processing:</strong> Each conversation is processed individually for better summary quality and detailed analysis.
                    </div>
                    
                    <div id="progress-container">
                        <div class="progress">
                            <div class="progress-bar-inner" id="progress-bar" style="width: 0%"></div>
                        </div>
                        {% if dev_mode %}
                            <p id="progress-text">Starting summary generation...</p>
                        {% else %}
                            <p id="progress-text">‚úÖ Instructions Generated, now creating individual summaries...</p>
                        {% endif %}
                    </div>
                </div>

                <script>
                // Auto-start individual inference when Step 5 loads
                $(document).ready(function() {
                    const isDevMode = {{ 'true' if dev_mode else 'false' }};
                    const initialDelay = isDevMode ? 500 : 2500; // Dev: 500ms, Production: 2.5s

                    // Calculate total conversations (limited to 5) - define outside for access in all handlers
                    const totalConversations = Math.min(5, {{survey_data.responses|length|default(0)}});
                    
                    // Trigger inference automatically with conditional delay
                    setTimeout(function() {
                        const progressBar = $('#progress-bar');
                        const progressText = $('#progress-text');
                        let currentConversation = 0;
                        
                        // Initial message
                        progressText.fadeOut(300, function() {
                            $(this).text('Initializing summary generation...').fadeIn(300);
                        });
                        
                        // Simulate realistic per-conversation progress
                        const simulateConversationProgress = () => {
                            currentConversation++;
                            
                            // Calculate actual percentage based on completed conversations
                            const progressPercent = (currentConversation / totalConversations) * 85; // Cap at 85% until real completion
                            
                            // Update progress bar smoothly
                            progressBar.animate({width: progressPercent + '%'}, 500);
                            
                            // Update text to show X/Y progress
                            if (currentConversation <= totalConversations) {
                                progressText.fadeOut(200, function() {
                                    $(this).text(`Processing conversation ${currentConversation} of ${totalConversations}...`).fadeIn(200);
                                });
                            }
                            
                            // Schedule next update if not done
                            if (currentConversation < totalConversations) {
                                // 2-3 seconds per conversation (realistic for API calls)
                                setTimeout(simulateConversationProgress, 2000 + Math.random() * 1000);
                            }
                        };
                        
                        // Start progress simulation after initial delay
                        setTimeout(simulateConversationProgress, 1000);
                        
                        // Actually start the individual inference processing
                        $.ajax({
                            url: '/run_inference',
                            method: 'POST',
                            timeout: 300000, // 5 minute timeout for individual processing
                            success: function(response) {
                                // Stop any remaining simulated progress
                                clearTimeout(window.progressTimeout);
                                
                                // Show completion with actual count
                                progressBar.stop().animate({width: '100%'}, 300);
                                progressText.fadeOut(200, function() {
                                    $(this).text(`All ${totalConversations} conversations summarized! ‚ú®`).fadeIn(200);
                                });
                                
                                setTimeout(() => {
                                    window.location.href = response.redirect || '/step/6';
                                }, 1500);
                            },
                            error: function(xhr, status, error) {
                                console.error('Individual processing error:', xhr.responseText);
                                let errorMsg = 'Error occurred during summary generation';
                                if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errorMsg += ': ' + xhr.responseJSON.message;
                                }
                                progressText.text(errorMsg);
                                progressText.css('color', '#e74c3c');
                            }
                        });
                    }, initialDelay); // Conditional delay: dev=500ms, production=2500ms
                });
                </script>

            {% elif step == 6 %}
                <!-- Step 6: Feedback Collection -->
                <div class="step-container">
                    <h2>Step 6: Provide Feedback</h2>
                    <p>Your corrections will be used to generate the final results:</p>
                    
                    <div class="feedback-container">
                        {% if results %}
                            <!-- Summary Review Interface -->
                            <div class="compact-review-section">
                                <h3>Review AI Summaries ({{ results|length }} conversations)</h3>
                                <p>Review the AI-generated summaries and make corrections if needed:</p>
                                
                                <div class="review-list">
                                    {% for result in results[:50] %}
                                        <div class="review-item" data-index="{{ result.index }}">
                                            <div class="review-item-horizontal">
                                                <!-- Left side: Conversation (65%) -->
                                                <div class="conversation-column">
                                                    <h5>Conversation #{{ result.index + 1 }}</h5>
                                                    <div class="conversation-text">{{ result.response_text }}</div>
                                                </div>
                                                
                                                <!-- Right side: Summary (35%) -->
                                                <div class="summary-column">
                                                    <h5>AI Summary</h5>
                                                    <div class="summary-text">{{ result.ai_summary|default(result.ai_classification) }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Bottom: Controls (full width) -->
                                            <div class="review-controls">
                                                <label class="correct-checkbox">
                                                    <input type="checkbox" class="is-correct" checked data-original="{{ result.ai_summary|default(result.ai_classification) }}">
                                                    <span>‚úì Summary is Correct</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Hidden correction section -->
                                            <div class="correction-section" style="display: none;">
                                                <label>Corrected Summary:</label>
                                                <textarea class="summary-correction" rows="3">{{ result.ai_summary|default(result.ai_classification) }}</textarea>
                                                <textarea class="feedback-text" placeholder="Optional: Why does this need correction?" rows="2"></textarea>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <strong>üö® No Results Found:</strong> No inference results are available. This means:<br>
                                ‚Ä¢ Step 5 (Run Inference) may not have completed successfully<br>
                                ‚Ä¢ Session data may have been lost<br>
                                ‚Ä¢ There may be an issue with the batch processing<br>
                                <br>
                                <strong>Session Debug:</strong><br>
                                ‚Ä¢ session.get('inference_results'): {{ session.get('inference_results', 'Not found') }}<br>
                                ‚Ä¢ session.get('classes'): {{ session.get('classes', 'Not found') }}<br>
                            </div>
                        {% endif %}
                    </div>
                    
                    <button id="submit-feedback" class="btn btn-primary">Submit Feedback & View Final Results</button>
                    
                    <!-- Debug and Export Info - moved to bottom -->
                    {% if dev_mode %}
                        {% if results %}
                            <div class="debug-section" style="margin-top: 40px;">
                                {% if session.get('last_results_file') %}
                                    <div class="alert alert-info">
                                        <strong>üíæ Results Exported:</strong> Inference results have been saved to <code>{{ session.last_results_file }}</code> for analysis and debugging.
                                    </div>
                                {% endif %}
                                
                                <div class="debug-info" style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-family: monospace; font-size: 11px; border: 1px solid #dee2e6;">
                                    <strong>üîç Debug Info:</strong><br>
                                    Results count: {{ results|length if results else 0 }}<br>
                                    Classes count: {{ classes|length if classes else 0 }}<br>
                                    
                                    {% if classes %}
                                        <strong>Expected Classes:</strong><br>
                                        {% for key, class_info in classes.items() %}
                                            &nbsp;&nbsp;‚Ä¢ "{{ class_info.name }}"<br>
                                        {% endfor %}
                                    {% endif %}

                                    {% if results %}
                                        <strong>AI Classifications Found:</strong><br>
                                        {% set unique_classifications = [] %}
                                        {% for result in results %}
                                            {% if result.ai_classification not in unique_classifications %}
                                                {% set _ = unique_classifications.append(result.ai_classification) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% for classification in unique_classifications %}
                                            &nbsp;&nbsp;‚Ä¢ "{{ classification }}"<br>
                                        {% endfor %}

                                        <strong>Sample Responses:</strong><br>
                                        {% for result in results[:2] %}
                                            &nbsp;&nbsp;{{ loop.index }}. "{{ result.response_text[:50] }}..." ‚Üí "{{ result.ai_classification }}"<br>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if session.get('last_results_file') %}
                                        <strong>üìÅ Results file:</strong> {{ session.last_results_file.split('/')[-1] }}<br>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

            {% elif step == 7 %}
                <!-- Step 7: Final Results -->
                <div class="step-container">
                    <h2>Step 7: Final Results</h2>
                    <p>Custom summary optimization complete! Here are your final results:</p>
                    
                    <div class="results-summary">
                        {% if final_results %}
                            <h3>üìä Feedback Summary</h3>
                            
                            <!-- Calculate feedback statistics -->
                            {% set total_examples = final_results|length %}
                            {% set feedback_data = user_feedback.get('feedback', []) %}
                            {% set changes_count = user_feedback.get('changes_count', 0) %}
                            {% set correct_count = total_examples - changes_count %}
                            
                            <div class="feedback-summary">
                                <div class="summary-highlight">
                                    <strong>Your feedback indicates that {{ correct_count }} out of {{ total_examples }} examples have been inferred as the correct category.</strong>
                                </div>
                                
                                <!-- Category breakdown -->
                                <h4>üìà Category Breakdown:</h4>
                                {% set ai_classification_counts = {} %}
                                {% set corrected_counts = {} %}
                                
                                <!-- Count AI classifications -->
                                {% for result in final_results %}
                                    {% set ai_class = result.ai_classification %}
                                    {% set _ = ai_classification_counts.update({ai_class: ai_classification_counts.get(ai_class, 0) + 1}) %}
                                {% endfor %}
                                
                                <!-- Count corrections -->
                                {% for correction in feedback_data %}
                                    {% set new_class = correction.new_classification %}
                                    {% set _ = corrected_counts.update({new_class: corrected_counts.get(new_class, 0) + 1}) %}
                                {% endfor %}
                                
                                <div class="category-breakdown">
                                    {% for class_key, class_info in classes.items() %}
                                        {% set ai_count = ai_classification_counts.get(class_info.name, 0) %}
                                        {% set corrections_from_this_category = feedback_data|selectattr('original_classification', 'equalto', class_info.name)|list|length %}
                                        {% set corrections_to_this_category = feedback_data|selectattr('new_classification', 'equalto', class_info.name)|list|length %}
                                        
                                        <!-- True count = AI classified + corrections TO this category - corrections FROM this category -->
                                        {% set true_count = ai_count + corrections_to_this_category - corrections_from_this_category %}
                                        
                                        <!-- Correctly inferred = AI classified correctly (not corrected away from this category) -->
                                        {% set correctly_inferred = ai_count - corrections_from_this_category %}
                                        
                                        <div class="category-stat">
                                            <span class="category-name">{{ class_info.name }}:</span>
                                            <span class="category-details">
                                                <strong>{{ correctly_inferred }} / {{ true_count }} correct</strong>
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Iteration Options -->
                            {% if user_feedback.get('changes_count', 0) > 0 and iteration_count < 3 %}
                                <div class="iteration-section">
                                    <h3>üîÑ Improve Your Results</h3>
                                    <p>Based on your feedback, we can refine the summarization instructions to improve accuracy. 
                                       {% if iteration_count > 0 %}This is iteration {{ iteration_count + 1 }} of 3.{% endif %}</p>
                                    
                                    {% if iteration_history %}
                                        <div class="iteration-history">
                                            <h4>Previous Iterations:</h4>
                                            {% for hist in iteration_history %}
                                                <div class="iteration-item">
                                                    <strong>Iteration {{ hist.iteration }}:</strong> 
                                                    {{ hist.rationale[:100] }}...
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="iteration-buttons">
                                        <button id="iterate-prompt" class="btn btn-primary">üîÑ Iterate on instructions</button>
                                        <button id="finish-session" class="btn btn-secondary">‚úÖ Finish Session</button>
                                    </div>
                                </div>
                            {% elif iteration_count >= 3 %}
                                <div class="iteration-limit-reached">
                                    <h3>üìä Maximum Iterations Reached</h3>
                                    <p>You've completed 3 iterations. The instructions have been refined based on your feedback.</p>
                                </div>
                            {% endif %}
                            
                            <!-- Prompt Display -->
                            <div class="prompt-display">
                                <h3>üéØ Summarization Instructions Used</h3>
                                <p>These is the final instructions that was used for classification:</p>
                                <div class="prompt-text">
                                    <pre>{{ prompt }}</pre>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <a href="{{ url_for('index') }}" class="btn btn-secondary">Start New Session</a>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>No results available.</strong> Please complete the full workflow to see final results.
                            </div>
                        {% endif %}
                    </div>
                </div>

            {% elif step == 7.5 %}
                <!-- Step 7.5: Prompt Iteration Analysis -->
                <div class="step-container">
                    <h2>Step 7.5: Instructions Analysis & Improvement</h2>
                    <p>We've analyzed your feedback and generated an improved instructions. Review the changes below:</p>
                    
                    {% if iteration_data %}
                        <!-- Feedback Analysis Summary -->
                        <div class="feedback-analysis-summary">
                            <h3>üìä Feedback Analysis</h3>
                            {% set analysis = iteration_data.feedback_analysis %}
                            <div class="analysis-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Corrections:</span>
                                    <span class="stat-value">{{ analysis.total_corrections }}</span>
                                </div>
                                {% if analysis.common_errors %}
                                    <div class="common-errors">
                                        <h4>Most Common Issues:</h4>
                                        {% for error in analysis.common_errors[:3] %}
                                            <div class="error-pattern">
                                                <strong>{{ error.pattern }}</strong> ({{ error.count }} times)
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Technical Strategy -->
                        <div class="improvement-rationale">
                            <h3>üîß Technical Rationale</h3>
                            <div class="rationale-text">
                                {{ iteration_data.rationale }}
                            </div>
                        </div>
                        
                        <!-- Unified Diff Display -->
                        <div class="prompt-diff-container">
                            <h3>üîç Detailed Changes</h3>
                            
                            <!-- Diff Statistics -->
                            <div class="diff-stats">
                                <div class="stat-badge">
                                    <span class="stat-label">Similarity:</span>
                                    <span class="stat-value">{{ iteration_data.diff_data.similarity_ratio }}%</span>
                                </div>
                                <div class="stat-badge">
                                    <span class="stat-label">Changes:</span>
                                    <span class="stat-value">{{ iteration_data.diff_data.changes_count }} sections</span>
                                </div>
                            </div>
                            
                            <!-- Inline Diff View -->
                            <div class="inline-diff-container">
                                <h4>üìù Unified View with Highlights</h4>
                                <div class="diff-legend">
                                    <span class="legend-item">
                                        <span class="diff-added">Green = Added</span>
                                    </span>
                                    <span class="legend-item">
                                        <span class="diff-deleted">Red = Removed</span>  
                                    </span>
                                    <span class="legend-item">
                                        Black = Unchanged
                                    </span>
                                </div>
                                <div class="inline-diff-display">
                                    {{ iteration_data.diff_data.inline_diff_html|safe }}
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="iteration-actions">
                            <button id="approve-iteration" class="btn btn-primary">‚úÖ Apply Changes & Continue</button>
                            <button id="reject-iteration" class="btn btn-secondary">‚ùå Keep Original instructions</button>
                        </div>
                        
                    {% else %}
                        <div class="alert alert-warning">
                            <strong>No iteration data available.</strong> Returning to results...
                        </div>
                        <script>
                            setTimeout(() => {
                                window.location.href = "{{ url_for('show_step', step_num=7) }}";
                            }, 3000);
                        </script>
                    {% endif %}
                </div>
                
            {% endif %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>